<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MEXC Scalper • Enhanced Trading Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
  :root { 
    --bg-primary: linear-gradient(135deg, #0a0e1a 0%, #0f1419 50%, #1a1f2e 100%);
    --bg-secondary: #121a2b;
    --bg-card: linear-gradient(145deg, #1a2332 0%, #0f1419 100%);
    --bg-surface: rgba(26, 35, 56, 0.6);
    --bg-input: rgba(14, 21, 38, 0.8);
    
    --text-primary: #eaf0ff;
    --text-secondary: #b8c5e3;
    --text-muted: #8fa1c7;
    --text-accent: #64b5f6;
    
    --border-primary: rgba(42, 58, 87, 0.6);
    --border-secondary: rgba(26, 35, 56, 0.8);
    
    --accent-blue: #1976d2;
    --accent-teal: #00acc1;
    --accent-green: #43a047;
    --accent-orange: #ff8f00;
    --accent-red: #e53935;
    
    --profit-color: #00ff88;
    --profit-glow: rgba(0, 255, 136, 0.3);
    --loss-color: #f44336;
    --neutral-color: #64b5f6;
    --neon-green: #39ff14;
    --electric-green: #00ff41;
    
    --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.15);
    --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.2);
    --shadow-elevated: 0 12px 40px rgba(0, 0, 0, 0.3);
    --shadow-green: 0 0 20px rgba(0, 255, 136, 0.2);
  }

  * { box-sizing: border-box; }
  
  body { 
    margin: 0; 
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-primary); 
    background: var(--bg-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(ellipse at top, rgba(25, 118, 210, 0.05) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
  }

  header { 
    padding: 20px 24px; 
    border-bottom: 1px solid var(--border-primary);
    background: rgba(18, 26, 43, 0.9);
    backdrop-filter: blur(10px);
    display: flex; 
    align-items: center; 
    gap: 16px;
    position: relative;
    box-shadow: var(--shadow-soft);
  }

  h1 { 
    margin: 0; 
    font-size: 24px; 
    font-weight: 600;
    background: linear-gradient(135deg, var(--accent-blue), var(--profit-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .pill {
    background: linear-gradient(145deg, rgba(31, 43, 69, 0.8), rgba(20, 30, 48, 0.9));
    padding: 8px 14px; 
    border-radius: 20px; 
    color: var(--text-secondary); 
    font-size: 12px;
    font-weight: 500;
    border: 1px solid var(--border-primary);
    box-shadow: var(--shadow-soft);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .pill.live {
    background: linear-gradient(145deg, rgba(0, 255, 136, 0.2), rgba(57, 255, 20, 0.1));
    color: var(--profit-color);
    border-color: rgba(0, 255, 136, 0.4);
    box-shadow: var(--shadow-green);
  }

  .pill.halted {
    background: linear-gradient(145deg, rgba(244, 67, 54, 0.2), rgba(229, 57, 53, 0.1));
    color: #ef5350;
    border-color: rgba(244, 67, 54, 0.4);
    box-shadow: 0 0 20px rgba(244, 67, 54, 0.1);
  }

  a.link { 
    color: var(--accent-teal); 
    text-decoration: none; 
    transition: all 0.3s ease;
  } 
  
  a.link:hover { 
    color: var(--profit-color);
    text-decoration: underline;
    text-shadow: 0 0 8px var(--profit-glow);
  }

  .backend-section {
    padding: 16px 24px;
    background: rgba(18, 26, 43, 0.4);
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .backend-section label {
    color: var(--text-secondary);
    font-weight: 500;
  }

  .wrap { 
    padding: 24px; 
    display: grid; 
    grid-template-columns: 1.3fr 1fr; 
    gap: 24px;
    max-width: 1600px;
    margin: 0 auto;
  }

  .card { 
    background: var(--bg-card);
    border: 1px solid var(--border-primary);
    border-radius: 16px; 
    padding: 20px;
    box-shadow: var(--shadow-card);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--profit-color), transparent);
    opacity: 0.4;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-elevated);
    border-color: rgba(0, 255, 136, 0.3);
  }

  h2 { 
    margin: 0 0 16px; 
    font-size: 18px; 
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .grid { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 16px;
  }

  .kpi { 
    background: linear-gradient(145deg, rgba(14, 21, 38, 0.8), rgba(26, 35, 56, 0.4));
    border: 1px solid var(--border-secondary);
    border-radius: 12px; 
    padding: 16px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .kpi::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, var(--accent-blue), var(--profit-color));
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .kpi:hover::before {
    opacity: 1;
  }

  .kpi:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-soft);
    border-color: rgba(0, 255, 136, 0.2);
  }

  .kpi .label {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .kpi .v { 
    font-size: 20px; 
    font-weight: 600;
    margin-top: 8px;
    color: var(--text-primary);
  }

  .kpi .v.positive { 
    color: var(--profit-color); 
    text-shadow: 0 0 10px var(--profit-glow);
  }
  .kpi .v.negative { color: var(--loss-color); }
  .kpi .v.neutral { color: var(--neutral-color); }

  table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 12px;
    background: rgba(14, 21, 38, 0.3);
    border-radius: 8px;
    overflow: hidden;
  }

  thead tr {
    background: linear-gradient(90deg, rgba(25, 118, 210, 0.1), rgba(0, 255, 136, 0.1));
  }

  td, th { 
    padding: 12px 16px; 
    border-bottom: 1px solid rgba(42, 58, 87, 0.3);
    color: var(--text-secondary); 
    text-align: left;
  }

  th {
    font-weight: 600;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 11px;
  }

  tr:hover {
    background: rgba(0, 255, 136, 0.05);
  }

  .logs { 
    max-height: 280px; 
    overflow: auto; 
    font-family: 'SF Mono', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 12px; 
    background: linear-gradient(145deg, rgba(14, 21, 38, 0.9), rgba(10, 14, 26, 0.8));
    border: 1px solid var(--border-secondary);
    border-radius: 8px; 
    padding: 16px;
    line-height: 1.6;
    color: #e8eaed;
  }

  .logs::-webkit-scrollbar { width: 6px; }
  .logs::-webkit-scrollbar-track { background: rgba(42, 58, 87, 0.2); border-radius: 3px; }
  .logs::-webkit-scrollbar-thumb { background: rgba(0, 255, 136, 0.3); border-radius: 3px; }

  .smallgrid { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 16px; 
    margin-top: 16px;
  }

  .streak { 
    background: linear-gradient(145deg, rgba(14, 21, 38, 0.8), rgba(26, 35, 56, 0.4));
    border: 1px solid var(--border-secondary);
    border-radius: 12px; 
    padding: 16px;
    transition: all 0.3s ease;
  }

  .streak:hover { transform: translateY(-1px); box-shadow: var(--shadow-soft); }
  .streak b { color: var(--text-primary); font-weight: 600; }

  .positive { color: var(--profit-color) !important; font-weight: 600; }
  .negative { color: var(--loss-color) !important; font-weight: 600; }

  input, select, button { 
    background: var(--bg-input);
    color: var(--text-primary); 
    border: 1px solid var(--border-primary);
    border-radius: 8px; 
    padding: 10px 14px;
    font-family: inherit;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  input:focus, select:focus {
    outline: none;
    border-color: var(--profit-color);
    box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
    background: rgba(26, 35, 56, 0.8);
  }

  button { 
    cursor: pointer;
    background: linear-gradient(145deg, var(--accent-blue), #1565c0);
    border: none;
    color: white;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
  }
  button:hover { transform: translateY(-1px); box-shadow: 0 4px 15px var(--profit-glow); background: linear-gradient(145deg, var(--profit-color), var(--accent-blue)); }

  .chart-container { position: relative; height: 300px; margin-top: 10px; }

  .status-indicator { display: inline-flex; align-items: center; gap: 6px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--profit-color); box-shadow: 0 0 15px var(--profit-glow); animation: pulse 2s infinite; }
  .status-dot.halted { background: var(--accent-red); box-shadow: 0 0 10px rgba(244, 67, 54, 0.5); }
  @keyframes pulse { 0%,100%{opacity:1; transform:scale(1);} 50%{opacity:.7; transform:scale(1.1);} }

  .metric-icon { color: var(--profit-color); margin-right: 8px; filter: drop-shadow(0 0 3px var(--profit-glow)); }

  @media (max-width: 1200px) { .wrap { grid-template-columns: 1fr; } .grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 768px)  { .grid { grid-template-columns: 1fr; } .smallgrid { grid-template-columns: 1fr; } header { flex-wrap: wrap; } }
  </style>
</head>
<body>
<header>
  <h1><i class="fas fa-chart-line metric-icon"></i>MEXC Scalper • Enhanced Dashboard</h1>
  <span class="pill" id="drypill"><i class="fas fa-flask"></i> DRY</span>
  <span class="pill status-indicator" id="haltpill">
    <span class="status-dot"></span>
    <span>LIVE</span>
  </span>
  <span class="pill status-indicator" id="masterpill">
    <span class="status-dot"></span>
    <span>MASTER: LIVE</span>
  </span>
  <span class="pill status-indicator" id="ssepill" title="Server-Sent Events stream">
    <span class="status-dot"></span>
    <span>SSE: OK</span>
  </span>
  <a class="pill link" id="pnlcsv" target="_blank"><i class="fas fa-download"></i> pnl.csv</a>
  <a class="pill link" id="logscsv" target="_blank"><i class="fas fa-file-alt"></i> logs.csv</a>
  <a class="pill link" id="config" target="_blank"><i class="fas fa-cog"></i> config</a>
</header>

<div class="backend-section">
  <label><i class="fas fa-server"></i> Backend URL:</label>
  <input id="base" style="min-width:360px;" value="https://mexc-scalper-production.up.railway.app" />
  <button id="save"><i class="fas fa-save"></i> Use</button>
  <span id="msg" style="margin-left:12px;color:var(--text-muted);font-weight:500;"></span>
</div>

<div class="wrap">
  <div class="card">
    <h2><i class="fas fa-chart-area metric-icon"></i>Equity Curve (realized PnL)</h2>
    <div class="chart-container"><canvas id="eq"></canvas></div>
  </div>
  
  <div class="card">
    <h2><i class="fas fa-tachometer-alt metric-icon"></i>Performance</h2>
    <div class="grid" id="kpis"></div>
    <div class="smallgrid">
      <div class="streak">
        <div><b><i class="fas fa-fire metric-icon"></i> Streaks</b></div>
        <div>Current Wins: <span id="cwin" class="positive">—</span></div>
        <div>Current Losses: <span id="closs" class="negative">—</span></div>
        <div>Max Wins: <span id="mwin" class="positive">—</span></div>
        <div>Max Losses: <span id="mloss" class="negative">—</span></div>
      </div>
      <div class="streak">
        <div><b><i class="fas fa-arrow-trend-down"></i> Drawdown</b></div>
        <div>Max DD (USDT): <span id="ddval" class="negative">—</span></div>
        <div style="color: var(--text-muted); font-size: 12px;">Peak/Valley visible in chart</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2><i class="fas fa-chart-line metric-icon"></i>Drawdown Curve (USDT from peak)</h2>
    <div class="chart-container"><canvas id="dd"></canvas></div>
  </div>
  
  <div class="card">
    <h2><i class="fas fa-chart-bar metric-icon"></i>Win/Loss Distribution (Realized USDT per trade)</h2>
    <div class="chart-container"><canvas id="hist"></canvas></div>
  </div>

  <div class="card">
    <h2><i class="fas fa-calendar-alt metric-icon"></i>Daily Summary (UTC @ reset)</h2>
    <table id="daily">
      <thead>
        <tr>
          <th>Day@Hour</th><th>Trades</th><th>Wins</th><th>Losses</th>
          <th>Win%</th><th>PF</th><th>Gross P</th><th>Gross L</th><th>Net</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2><i class="fas fa-satellite-dish metric-icon"></i>Live Feed</h2>
    <div class="logs" id="live"></div>
  </div>

  <div class="card">
    <h2><i class="fas fa-history metric-icon"></i>Recent Trades</h2>
    <table id="trades">
      <thead>
        <tr>
          <th>Time (UTC)</th><th>Symbol</th><th>Side</th><th>Price</th><th>Size</th><th>Realized</th><th>Fee</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Optimizer card (adds only; style/theme unchanged) -->
  <div class="card" id="optimizerCard">
    <h2>
      <i class="fas fa-robot" style="color:#00ff88;margin-right:8px;"></i>
      Optimizer (GPT-5 via OpenRouter)
    </h2>

    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
      <button id="optSuggestBtn"><i class="fas fa-pen"></i> SUGGEST PARAMS</button>
      <button id="optApplyBtn"><i class="fas fa-check-circle"></i> APPLY PROPOSAL</button>
      <span id="optStatus" style="align-self:center; color:var(--text-muted); font-weight:500;"></span>
    </div>

    <div style="margin-bottom:10px; color:var(--text-secondary); font-weight:600;">Proposal (JSON)</div>
    <textarea id="optJson" spellcheck="false"
      style="width:100%; min-height:170px; background:var(--bg-input); color:var(--text-primary);
             border:1px solid var(--border-primary); border-radius:8px; padding:12px; font-family:ui-monospace,monospace;">{}</textarea>

    <div style="margin-top:14px; margin-bottom:10px; color:var(--text-secondary); font-weight:600;">Model Notes</div>
    <textarea id="optNotes" spellcheck="false" placeholder="—"
      style="width:100%; min-height:110px; background:var(--bg-input); color:var(--text-primary);
             border:1px solid var(--border-primary); border-radius:8px; padding:12px; font-family:ui-monospace,monospace;"></textarea>
  </div>
</div>

<script>
const StorageKey = 'mexc_backend_url';
const kDefs = [
  { id:"trades", label:"Trades", icon:"fas fa-exchange-alt" },
  { id:"winrate", label:"Win Rate", icon:"fas fa-percentage" },
  { id:"net", label:"Net PnL (USDT)", icon:"fas fa-wallet" },
  { id:"gprofit", label:"Gross Profit", icon:"fas fa-arrow-up" },
  { id:"gloss", label:"Gross Loss", icon:"fas fa-arrow-down" },
  { id:"pf", label:"Profit Factor", icon:"fas fa-balance-scale" },
  { id:"avgwin", label:"Avg Win", icon:"fas fa-trophy" },
  { id:"avgloss", label:"Avg Loss", icon:"fas fa-minus-circle" },
  { id:"dd", label:"Max Drawdown", icon:"fas fa-arrow-trend-down" }
];

function el(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; }
const kpiWrap = document.getElementById('kpis');
kDefs.forEach(k => {
  const kpiElement = el(`
    <div class="kpi">
      <div class="label"><i class="${k.icon} metric-icon"></i>${k.label}</div>
      <div class="v" id="${k.id}">—</div>
    </div>
  `);
  kpiWrap.appendChild(kpiElement);
});

// Chart.js options
const chartOptions = {
  animation: false,
  responsive: true,
  maintainAspectRatio: false,
  plugins: { legend: { display: false } },
  scales: {
    x: { ticks: { autoSkip: true, maxRotation: 0, color: '#8fa1c7' }, grid: { color: 'rgba(143, 161, 199, 0.1)' } },
    y: { ticks: { color: '#8fa1c7' }, grid: { color: 'rgba(143, 161, 199, 0.1)' } }
  }
};

const eqChart = new Chart(document.getElementById('eq'), {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'Equity (USDT)', data: [], tension: 0.3,
    borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', borderWidth: 2,
    pointBackgroundColor: '#00ff88', pointBorderColor: '#ffffff', pointBorderWidth: 2,
    pointRadius: 0, pointHoverRadius: 6, fill: true }]},
  options: chartOptions
});

const ddChart = new Chart(document.getElementById('dd'), {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'Drawdown (USDT)', data: [], tension: 0.3,
    borderColor: '#f44336', backgroundColor: 'rgba(244,67,54,0.1)', borderWidth: 2,
    pointBackgroundColor: '#f44336', pointBorderColor: '#ffffff', pointBorderWidth: 2,
    pointRadius: 0, pointHoverRadius: 6, fill: true }]},
  options: chartOptions
});

const histChart = new Chart(document.getElementById('hist'), {
  type: 'bar',
  data: { labels: [], datasets: [{ label: 'Trades', data: [], backgroundColor: 'rgba(0,255,136,0.7)', borderColor: '#00ff88', borderWidth: 1 }] },
  options: { ...chartOptions, scales: { ...chartOptions.scales, x: { ...chartOptions.scales.x, type: 'category', position: 'bottom' } } }
});

const baseInput = document.getElementById('base');
const msg = document.getElementById('msg');
function BASE(){ return (localStorage.getItem(StorageKey)||'').replace(/\/+$/,''); }
function setBase(u){ localStorage.setItem(StorageKey, u.replace(/\/+$/,'')); }
document.getElementById('save').onclick = ()=> { 
  setBase(baseInput.value || ''); 
  msg.textContent='✓ Saved'; 
  msg.style.color='#00ff88';
  setTimeout(()=>{ msg.textContent=''; msg.style.color='var(--text-muted)'; }, 2000); 
  rebindLinks(); 
};

function rebindLinks(){
  const url = BASE();
  document.getElementById('pnlcsv').href  = url + "/pnl.csv";
  document.getElementById('logscsv').href = url + "/logs.csv";
  document.getElementById('config').href  = url + "/config";
}
baseInput.value = BASE() || 'https://mexc-scalper-production.up.railway.app'; rebindLinks();

async function fetchJSON(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json(); }
async function fetchText(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.text(); }

function updateKPIValue(id, value, isProfit = null) {
  const element = document.getElementById(id);
  if (!element) return;
  element.textContent = value;
  element.className = 'v';
  if (isProfit === true) element.classList.add('positive');
  else if (isProfit === false) element.classList.add('negative');
  else element.classList.add('neutral');
}

async function refresh(){
  const url = BASE(); if(!url) return;
  try{
    const health = await fetchJSON(url + "/health");
    document.getElementById('drypill').innerHTML = `<i class="fas fa-flask"></i> DRY: ${String(health.dry)}`;
    const mp = document.getElementById('masterpill');
    if (health.globalHalt) { 
      mp.innerHTML = '<span class="status-dot halted"></span><span>MASTER: HALTED</span>';
      mp.classList.add('halted'); mp.classList.remove('live');
    } else { 
      mp.innerHTML = '<span class="status-dot"></span><span>MASTER: LIVE</span>';
      mp.classList.add('live'); mp.classList.remove('halted');
    }
    const pill = document.getElementById('haltpill');
    if (health.globalHalt) { 
      pill.innerHTML = '<span class="status-dot halted"></span><span>HALTED</span>';
      pill.classList.add('halted'); pill.classList.remove('live');
    } else { 
      pill.innerHTML = '<span class="status-dot"></span><span>LIVE</span>';
      pill.classList.add('live'); pill.classList.remove('halted');
    }
  } catch {}

  const s = await fetchJSON(url + "/stats");
  updateKPIValue('trades', s.counts.trades);
  updateKPIValue('winrate', s.quality.winRate.toFixed(2) + "%", s.quality.winRate > 50);
  updateKPIValue('net', s.pnl.net.toFixed(4), s.pnl.net > 0);
  updateKPIValue('gprofit', s.pnl.grossProfit.toFixed(4), true);
  updateKPIValue('gloss', s.pnl.grossLoss.toFixed(4), false);
  updateKPIValue('pf', s.quality.profitFactor.toFixed(3), s.quality.profitFactor > 1);
  updateKPIValue('avgwin', s.quality.avgWin.toFixed(4), true);
  updateKPIValue('avgloss', s.quality.avgLoss.toFixed(4), false);
  updateKPIValue('dd', s.risk.maxDrawdown.toFixed(4), false);
  document.getElementById('ddval').textContent = s.risk.maxDrawdown.toFixed(4);
  document.getElementById('cwin').textContent = s.streaks.currentWins;
  document.getElementById('closs').textContent = s.streaks.currentLosses;
  document.getElementById('mwin').textContent = s.streaks.maxWins;
  document.getElementById('mloss').textContent = s.streaks.maxLosses;

  const eqLabels = s.equity.map(p => new Date(p.ts).toISOString().slice(11,19));
  eqChart.data.labels = eqLabels; eqChart.data.datasets[0].data = s.equity.map(p => p.equity); eqChart.update('none');

  const ddLabels = s.drawdown.map(p => new Date(p.ts).toISOString().slice(11,19));
  ddChart.data.labels = ddLabels; ddChart.data.datasets[0].data = s.drawdown.map(p => p.dd); ddChart.update('none');

  histChart.data.labels = s.hist.labels;
  histChart.data.datasets[0].data = s.hist.bins;
  histChart.update('none');

  const csv = await fetchText(url + "/pnl.csv");
  const lines = csv.trim().split(/\r?\n/).slice(1).reverse();
  const body = document.querySelector('#trades tbody');
  body.innerHTML = '';
  lines.slice(0, 25).forEach(l=>{
    const [ts,symbol,side,price,amount,fee,realized] = l.split(',');
    const sideL = (side||'').toLowerCase();
    const realizedNum = Number(realized||0);
    const realizedClass = realizedNum > 0 ? 'positive' : realizedNum < 0 ? 'negative' : '';
    const sideClass = sideL === 'buy' ? 'positive' : sideL === 'sell' ? 'negative' : '';
    const px = Number(price||0), amt = Number(amount||0), feeNum = Number(fee||0);
    const row = `
      <td>${(ts||'').replace('T',' ').slice(0,19)}</td>
      <td><strong>${symbol||''}</strong></td>
      <td><span class="${sideClass}">${side||''}</span></td>
      <td>${px.toFixed(4)}</td>
      <td>${amt.toFixed(6)}</td>
      <td><span class="${realizedClass}">${realizedNum.toFixed(6)}</span></td>
      <td>${feeNum.toFixed(6)}</td>`;
    const tr = document.createElement('tr'); tr.innerHTML = row; body.appendChild(tr);
  });
}

async function refreshDaily(){
  const url = BASE(); if(!url) return;
  const d = await fetchJSON(url + "/stats/daily");
  const body = document.querySelector('#daily tbody');
  body.innerHTML = '';
  (d.daily || []).slice(-30).forEach(row=>{
    const tr = document.createElement('tr');
    const netClass = row.net > 0 ? 'positive' : row.net < 0 ? 'negative' : '';
    tr.innerHTML = `
      <td><strong>${row.key}</strong></td>
      <td>${row.trades}</td>
      <td><span class="positive">${row.wins}</span></td>
      <td><span class="negative">${row.losses}</span></td>
      <td>${row.winRate.toFixed(2)}%</td>
      <td>${row.profitFactor.toFixed(2)}</td>
      <td><span class="positive">${row.grossProfit.toFixed(4)}</span></td>
      <td><span class="negative">${row.grossLoss.toFixed(4)}</span></td>
      <td><span class="${netClass}"><strong>${row.net.toFixed(4)}</strong></span></td>`;
    body.appendChild(tr);
  });
}

// ===== SSE feed with visibility pause + backoff reconnect =====
let ev = null, sseRetry = 0, sseStopped = false;
const ssePill = document.getElementById('ssepill');

function setSSEState(ok){
  if (!ssePill) return;
  const dot = ssePill.querySelector('.status-dot');
  if (ok){ dot.classList.remove('halted'); ssePill.lastElementChild.textContent = 'SSE: OK'; }
  else { dot.classList.add('halted'); ssePill.lastElementChild.textContent = 'SSE: OFF'; }
}

function openSSE(){
  const url = BASE(); if(!url || sseStopped) return;
  try{
    ev = new EventSource(url + "/stream");
    setSSEState(true); sseRetry = 0;
    const live = document.getElementById('live');
    function push(line, type=''){ const t=new Date().toISOString().slice(11,19);
      const icon = type==='exec'?'⚡': type==='fill'?'✅':'ℹ️';
      live.textContent += `${icon} [${t}] ${line}\n`; live.scrollTop = live.scrollHeight; }
    ev.addEventListener('open', ()=> setSSEState(true));
    ev.addEventListener('error', ()=>{ ev.close(); setSSEState(false); scheduleReconnect(); });
    ev.addEventListener('hello', ()=> push('SSE connected','info'));
    ev.addEventListener('log', e=>{ const d=JSON.parse(e.data); push(d.line,'log'); });
    ev.addEventListener('exec',e=>{ const d=JSON.parse(e.data); push(`EXEC ${d.signal} ${d.symbol} lev=${d.lev} notional=${d.notionalUSDT}`,'exec'); });
    ev.addEventListener('fill',e=>{ const d=JSON.parse(e.data); push(`FILL ${d.symbol} ${d.side} px=${d.price} amt=${d.amount} realized=${d.realized}`,'fill'); });
  }catch{ setSSEState(false); scheduleReconnect(); }
}
function scheduleReconnect(){
  if (sseStopped) return;
  sseRetry = Math.min(sseRetry + 1, 6); // cap
  const delay = Math.min(30000, 1000 * Math.pow(2, sseRetry)); // 1s,2s,4s,... up to 30s
  setTimeout(()=>{ if(!document.hidden) openSSE(); }, delay);
}
document.addEventListener('visibilitychange', ()=>{
  if (document.hidden){ sseStopped = true; if (ev){ ev.close(); } setSSEState(false); }
  else { sseStopped = false; openSSE(); }
});

// ===== Optimizer wiring =====
const optSuggestBtn = document.getElementById('optSuggestBtn');
const optApplyBtn   = document.getElementById('optApplyBtn');
const optStatus     = document.getElementById('optStatus');
const optJsonEl     = document.getElementById('optJson');
const optNotesEl    = document.getElementById('optNotes');

function setOptStatus(msg, ok=true){
  optStatus.textContent = msg || '';
  optStatus.style.color = ok ? '#00ff88' : '#e53935';
  if (msg) setTimeout(()=>{ optStatus.textContent=''; optStatus.style.color='var(--text-muted)'; }, 3000);
}
async function optimizerSuggest(){
  const url = BASE(); if (!url) return;
  try{
    setOptStatus('Fetching…', true);
    const token = localStorage.getItem('dash_token') || '';
    const res = await fetch(url + '/optimizer/suggest', {
      method: 'POST',
      headers: { 'X-Dashboard-Token': token }
    });
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    const proposal = data.proposal || data.params || data.suggestion || {};
    const notes = data.notes || data.explainer || data.message || '';
    optJsonEl.value = JSON.stringify(proposal, null, 2);
    optNotesEl.value = notes || '';
    setOptStatus('OK', true);
  }catch(e){
    optNotesEl.value = (e && e.message) ? e.message : String(e);
    setOptStatus('Failed', false);
  }
}
async function optimizerApply(){
  const url = BASE(); if (!url) return;
  let payload = null;
  try{ payload = JSON.parse(optJsonEl.value || '{}'); }
  catch{ setOptStatus('Proposal JSON is invalid', false); return; }
  try{
    setOptStatus('Applying…', true);
    const token = localStorage.getItem('dash_token') || '';
    const res = await fetch(url + '/optimizer/apply', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'X-Dashboard-Token': token },
      body: JSON.stringify({ proposal: payload })
    });
    if(!res.ok) throw new Error(await res.text());
    await res.json();
    setOptStatus('Applied', true);
    refresh(); refreshDaily();
  }catch(e){
    optNotesEl.value = (e && e.message) ? e.message : String(e);
    setOptStatus('Apply failed', false);
  }
}
if (optSuggestBtn) optSuggestBtn.addEventListener('click', optimizerSuggest);
if (optApplyBtn)   optApplyBtn.addEventListener('click', optimizerApply);

// boot
refresh(); refreshDaily(); openSSE();
setInterval(()=>{ refresh(); refreshDaily(); }, 4000);
</script>
</body>
</html>
